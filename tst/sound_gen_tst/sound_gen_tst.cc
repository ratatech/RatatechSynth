/*
@file adsr_tst.cc

@brief Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

@ Created by Jordi Hidalgo, Ratatech, Apr 23, 2017
This file is part of Ratatech 3019

    Ratatech 3019 is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Ratatech 3019 is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Ratatech 3019.  If not, see <http://www.gnu.org/licenses/>
*/

#include <stdio.h>
#include "unity.h"
#include "oscillator.h"
#include "tst_utils.h"

/**
 * Size of reference and output buffers
 */
#define BUFF_SIZE 4096

#define FRAME_SIZE_TEST

/**
 * ADSR envelope unit test reference buffer
 */
q15_t buff_sound_gen_out[BUFF_SIZE] = {0,1,5,10,17,26,34,44,54,63,73,80,87,92,95,96,93,88,80,69,56,40,21,0,-24,-48,-74,-100,-127,-152,-177,-199,-219,-230,-238,-242,
		-242,-238,-230,-217,-200,-180,-156,-129,-100,-68,-35,-1,34,69,103,136,167,195,220,242,260,274,283,287,287,282,271,256,236,211,183,151,116,79,40,0,-41,-82,-122,-159,
		-195,-228,-258,-283,-304,-319,-330,-334,-334,-327,-314,-296,-273,-244,-212,-175,-135,-92,-47,-1,46,93,138,181,222,260,293,322,345,363,374,378,377,369,355,335,308,276,
		239,197,151,103,52,0,-53,-106,-157,-205,-251,-293,-331,-362,-389,-407,-420,-425,-424,-415,-399,-375,-346,-310,-268,-220,-170,-115,-59,-1,58,116,173,227,278,325,365,
		400,429,451,464,470,468,458,440,414,381,340,294,242,186,126,64,0,-65,-129,-192,-251,-307,-358,-403,-442,-474,-496,-511,-517,-515,-504,-484,-455,-419,-375,-324,-267,
		-205,-139,-71,-1,70,140,208,273,334,390,439,481,515,539,556,562,560,547,525,494,454,405,350,288,221,150,76,0,-77,-153,-227,-297,-363,-423,-476,-521,-558,-584,-601,
		-608,-605,-592,-568,-534,-491,-439,-379,-312,-240,-163,-83,-1,82,164,243,319,390,454,510,559,598,627,646,653,650,635,609,573,526,470,405,334,256,174,88,0,-89,-176,
		-261,-342,-418,-487,-548,-600,-642,-672,-691,-699,-695,-680,-652,-613,-563,-503,-434,-357,-275,-186,-94,-1,94,187,278,364,444,518,583,638,682,715,736,743,739,722,692,
		651,598,534,461,379,291,197,99,0,-101,-200,-296,-388,-473,-551,-620,-679,-726,-760,-782,-790,-786,-767,-736,-692,-635,-568,-490,-403,-309,-210,-106,-1,106,211,313,410,
		500,583,655,716,766,803,826,835,830,811,777,730,671,598,516,425,326,221,111,0,-113,-224,-332,-433,-529,-616,-692,-757,-810,-849,-873,-882,-877,-856,-820,-770,-707,-632,
		-545,-449,-345,-234,-118,-1,118,234,348,455,556,647,728,796,851,891,916,926,920,899,861,809,743,663,572,470,361,244,123,0,-125,-247,-366,-479,-584,-680,-764,-836,-894,
		-935,-962,-972,-966,-943,-904,-849,-780,-696,-601,-494,-379,-257,-130,-1,130,258,383,501,611,711,799,874,934,979,1007,1017,1011,987,946,888,815,727,627,516,396,268,135,
		0,-137,-271,-401,-524,-640,-744,-837,-915,-978,-1023,-1052,-1063,-1056,-1031,-988,-928,-852,-760,-655,-539,-414,-281,-142,-1,141,281,417,546,666,775,871,953,1018,1066,
		1096,1107,1100,1073,1029,966,886,791,682,561,430,291,147,0,-148,-294,-435,-569,-694,-808,-908,-993,-1061,-1110,-1142,-1153,-1146,-1118,-1071,-1006,-923,-824,-710,-584,
		-448,-304,-154,-1,153,305,451,591,721,839,943,1031,1102,1153,1185,1197,1189,1160,1112,1044,958,854,737,606,464,314,159,0,-160,-317,-470,-614,-749,-872,-979,-1071,-1144,
		-1197,-1231,-1243,-1235,-1205,-1154,-1084,-995,-887,-765,-629,-483,-327,-166,-1,165,328,486,636,776,902,1014,1109,1185,1240,1274,1287,1278,1247,1195,1122,1029,918,791,
		651,499,338,170,0,-172,-341,-504,-659,-804,-935,-1051,-1149,-1227,-1284,-1320,-1333,-1324,-1292,-1238,-1162,-1066,-952,-820,-674,-517,-350,-177,-1,177,351,521,681,831,
		967,1085,1187,1268,1328,1365,1378,1369,1335,1279,1201,1101,982,847,696,534,361,182,0,-184,-364,-539,-705,-859,-1000,-1123,-1228,-1311,-1372,-1410,-1424,-1414,-1380,
		-1322,-1241,-1138,-1015,-875,-720,-552,-374,-189,-1,189,375,555,726,886,1030,1158,1265,1351,1414,1454,1468,1458,1421,1361,1278,1172,1046,902,741,568,384,194,0,-195,
		-387,-573,-749,-914,-1063,-1194,-1305,-1394,-1458,-1498,-1513,-1502,-1466,-1404,-1318,-1209,-1078,-929,-764,-586,-397,-201,-1,200,398,589,771,940,1093,1228,1343,1434,
		1500,1542,1557,1546,1508,1444,1356,1243,1109,956,786,602,408,206,0,-207,-410,-607,-794,-968,-1126,-1265,-1383,-1477,-1545,-1588,-1603,-1592,-1553,-1487,-1396,-1280,
		-1142,-984,-809,-621,-420,-213,-1,212,421,624,816,995,1157,1300,1420,1517,1587,1631,1647,1635,1595,1528,1433,1315,1173,1011,831,637,431,217,0,-219,-434,-642,-839,
		-1023,-1190,-1336,-1461,-1560,-1632,-1677,-1693,-1681,-1640,-1570,-1474,-1351,-1205,-1039,-854,-655,-444,-224,-1,224,444,658,861,1049,1221,1371,1498,1600,1674,1720,
		1737,1724,1682,1611,1511,1386,1236,1065,876,671,454,229,0,-231,-457,-676,-884,-1078,-1253,-1407,-1538,-1642,-1719,-1766,-1783,-1769,-1726,-1652,-1551,-1422,-1269,-1093,
		-899,-689,-467,-236,-1,235,467,692,905,1104,1283,1442,1575,1683,1760,1809,1826,1813,1768,1693,1588,1457,1299,1119,920,705,477,241,0,-242,-480,-710,-929,-1132,-1316,
		-1478,-1616,-1725,-1805,-1854,-1872,-1858,-1812,-1736,-1629,-1493,-1332,-1148,-944,-723,-490,-248,-1,247,491,726,950,1158,1347,1513,1653,1766,1847,1898,1916,1902,1855,
		1776,1666,1528,1363,1174,965,740,500,252,0,-254,-503,-745,-974,-1187,-1379,-1549,-1693,-1808,-1892,-1944,-1962,-1947,-1898,-1818,-1706,-1564,-1396,-1202,-988,-758,-513,
		-259,-1,259,514,761,995,1213,1410,1584,1730,1848,1933,1986,2005,1990,1941,1858,1743,1599,1426,1228,1010,774,523,264,0,-266,-526,-779,-1018,-1241,-1443,-1620,-1771,-1891,
		-1978,-2032,-2051,-2036,-1985,-1901,-1783,-1635,-1459,-1257,-1033,-792,-536,-271,-1,270,537,795,1040,1267,1473,1654,1808,1930,2020,2074,2094,2078,2027,1940,1821,1669,
		1489,1283,1054,808,547,276,0,-277,-549,-813,-1063,-1295,-1505,-1690,-1847,-1972,-2064,-2120,-2140,-2123,-2070,-1982,-1860,-1705,-1522,-1310,-1077,-826,-559,-282,-1,282,
		560,829,1084,1321,1536,1725,1885,2012,2105,2163,2183,2167,2113,2023,1898,1740,1552,1337,1099,842,570,287,0,-289,-572,-847,-1107,-1349,-1569,-1762,-1925,-2055,-2150,
		-2208,-2229,-2212,-2157,-2065,-1937,-1776,-1584,-1365,-1122,-860,-582,-294,-1,294,583,863,1129,1375,1599,1795,1962,2095,2192,2251,2272,2255,2199,2105,1975,1810,1614,
		1391,1143,876,593,299,0,-300,-596,-881,-1152,-1404,-1631,-1831,-2001,-2136,-2236,-2296,-2318,-2300,-2242,-2147,-2014,-1847,-1647,-1419,-1166,-894,-605,-306,-1,305,606,
		897,1173,1429,1662,1866,2038,2176,2277,2339,2361,2343,2284,2186,2051,1880,1677,1445,1188,909,615,310,0,-312,-619,-915,-1196,-1457,-1694,-1902,-2078,-2219,-2321,-2384,
		-2406,-2388,-2328,-2229,-2090,-1916,-1710,-1473,-1211,-928,-628,-317,-1,317,629,931,1217,1483,1724,1936,2115,2258,2363,2426,2449,2430,2370,2268,2128,1951,1740,1499,
		1232,944,638,322,0,-323,-641,-949,-1240,-1511,-1756,-1972,-2154,-2300,-2407,-2472,-2495,-2475,-2413,-2310,-2167,-1987,-1773,-1527,-1255,-962,-651,-329,-1,328,652,964,
		1261,1537,1787,2006,2191,2339,2448,2514,2538,2518,2455,2350,2204,2021,1803,1553,1276,977,661,333,0,-335,-664,-982,-1284,-1565,-1819,-2042,-2231,-2382,-2492,-2559,-2583,
		-2563,-2499,-2392,-2243,-2057,-1835,-1581,-1299,-996,-674,-340,-1,340,675,999,1306,1591,1849,2076,2268,2422,2534,2602,2626,2606,2541,2432,2281,2091,1865,1606,1320,1011,
		684,345,0,-347,-687,-1017,-1329,-1619,-1881,-2112,-2307,-2464,-2577,-2647,-2672,-2650,-2584,-2474,-2321,-2127,-1898,-1634,-1343,-1029,-697,-352,-1,351,697,1032,1350,
		1645,1912,2147,2344,2503,2619,2690,2715,2694,2626,2513,2357,2161,1928,1661,1365,1045,707,357,0,-358,-710,-1050,-1373,-1673,-1944,-2183,-2385,-2546,-2662,-2735,-2760,
		-2739,-2670,-2556,-2397,-2197,-1960,-1689,-1388,-1063,-720,-363,-1,363,720,1066,1394,1698,1974,2217,2421,2585,2705,2777,2803,2781,2712,2595,2435,2232,1990,1714,1409,
		1079,730,368,0,-370,-733,-1084,-1417,-1726,-2007,-2253,-2461,-2627,-2747,-2822,-2848,-2826,-2755,-2636,-2473,-2267,-2022,-1742,-1431,-1097,-742,-375,-1,374,743,1100,
		1438,1752,2036,2286,2497,2666,2789,2864,2891,2868,2796,2676,2510,2301,2052,1768,1453,1112,752,379,0,-381,-756,-1118,-1461,-1780,-2069,-2323,-2537,-2708,-2832,-2909,
		-2936,-2913,-2840,-2719,-2549,-2337,-2084,-1796,-1476,-1131,-765,-386,-1,386,766,1134,1482,1805,2099,2356,2574,2748,2875,2952,2979,2956,2882,2758,2587,2371,2114,1821,
		1497,1146,776,391,0,-393,-779,-1152,-1505,-1833,-2131,-2392,-2613,-2790,-2917,-2996,-3024,-3000,-2925,-2799,-2625,-2407,-2147,-1849,-1519,-1164,-788,-398,-1,397,788,
		1167,1526,1859,2161,2426,2649,2828,2959,3039,3067,3043,2966,2838,2662,2440,2177,1875,1541,1180,798,402,0,-404,-801,-1185,-1549,-1887,-2193,-2462,-2689,-2871,-3002,-3084,
		-3112,-3088,-3010,-2880,-2702,-2476,-2209,-1903,-1563,-1198,-811,-409,-1,409,811,1201,1570,1913,2223,2495,2725,2909,3044,3126,3154,3129,3051,2920,2738,2510,2238,1928,
		1584,1213,821,414,0,-416,-824,-1219,-1592,-1940,-2255,-2531,-2765,-2951,-3086,-3170,-3199,-3174,-3094,-2961,-2777,-2545,-2270,-1956,-1607,-1231,-833,-421,-1,420,834,
		1234,1613,1966,2285,2565,2801,2990,3128,3212,3242,3216,3135,3000,2814,2579,2300,1981,1628,1247,843,425,0,-427,-847,-1252,-1636,-1993,-2317,-2601,-2841,-3033,-3171,-3257,
		-3287,-3261,-3179,-3042,-2853,-2615,-2333,-2009,-1651,-1265,-856,-432,-1,432,857,1268,1657,2019,2347,2634,2877,3071,3213,3300,3329,3303,3220,3081,2890,2649,2362,2034,
		1672,1280,866,437,0,-438,-869,-1286,-1680,-2046,-2378,-2670,-2916,-3113,-3256,-3343,-3374,-3347,-3263,-3122,-2928,-2684,-2394,-2062,-1694,-1298,-878,-444,-1,443,879,
		1301,1701,2072,2408,2703,2952,3151,3297,3386,3416,3389,3304,3162,2965,2718,2423,2087,1715,1314,889,448,0,-450,-892,-1319,-1723,-2099,-2440,-2739,-2992,-3193,-3340,
		-3430,-3461,-3434,-3347,-3203,-3004,-2753,-2456,-2115,-1738,-1331,-901,-455,-1,454,902,1334,1744,2125,2470,2772,3028,3232,3381,3472,3503,3475,3388,3242,3041,2787,2485,
		2140,1759,1347,911,459,0,-461,-914,-1352,-1767,-2152,-2501,-2808,-3067,-3274,-3424,-3516,-3548,-3520,-3431,-3283,-3079,-2822,-2517,-2168,-1781,-1365,-923,-466,-1,466,
		924,1367,1788,2178,2531,2841,3103,3312,3465,3558,3590,3561,3472,3323,3116,2856,2546,2193,1802,1380,934,471,0,-472,-937,-1385,-1810,-2205,-2563,-2877,-3142,-3354,-3508,
		-3602,-3635,-3606,-3515,-3363,-3154,-2891,-2579,-2221,-1825,-1398,-946,-478,-1,477,947,1401,1831,2231,2593,2910,3178,3393,3549,3645,3677,3648,3556,3403,3191,2925,2608,
		2246,1846,1413,956,482,0,-484,-959,-1419,-1854,-2258,-2625,-2946,-3218,-3434,-3592,-3688,-3722,-3692,-3599,-3444,-3230,-2960,-2640,-2274,-1868,-1431,-968,-489,-1,488,
		969,1434,1875,2284,2654,2979,3254,3473,3633,3730,3764,3734,3640,3482,3266,2993,2669,2299,1889,1446,978,493,0,-495,-981,-1452,-1897,-2311,-2685,-3014,-3292,-3514,-3675,
		-3774,-3808,-3778,-3682,-3523,-3304,-3029,-2701,-2326,-1911,-1464,-991,-500,-1,500,991,1467,1918,2336,2715,3047,3328,3552,3716,3816,3850,3819,3723,3563,3341,3062,2730,
		2351,1932,1480,1001,505,0,-506,-1004,-1485,-1940,-2364,-2747,-3083,-3367,-3594,-3759,-3860,-3895,-3864,-3766,-3604,-3380,-3098,-2763,-2379,-1955,-1497,-1013,-512,-1,511,
		1014,1500,1961,2389,2777,3116,3403,3633,3800,3902,3937,3905,3807,3643,3416,3131,2792,2404,1976,1513,1023,516,0,-518,-1026,-1518,-1984,-2417,-2808,-3152,-3443,-3675,
		-3843,-3946,-3982,-3950,-3850,-3684,-3455,-3167,-2824,-2432,-1998,-1531,-1036,-523,-1,522,1036,1533,2004,2441,2838,3185,3478,3712,3883,3988,4024,3991,3890,3723,3491,
		3199,2852,2457,2019,1546,1046,527,0,-529,-1049,-1551,-2027,-2469,-2869,-3221,-3517,-3754,-3926,-4031,-4068,-4035,-3934,-3764,-3529,-3235,-2885,-2485,-2041,-1564,-1058,
		-534,-1,533,1059,1566,2048,2494,2899,3253,3553,3793,3967,4074,4110,4077,3974,3803,3566,3268,2914,2510,2062,1579,1068,539,0,-540,-1071,-1584,-2070,-2522,-2931,-3290,
		-3593,-3835,-4010,-4118,-4155,-4122,-4017,-3844,-3605,-3304,-2946,-2537,-2085,-1597,-1081,-545,-1,545,1081,1600,2091,2547,2960,3322,3628,3872,4050,4159,4197,4162,4057,
		3882,3641,3337,2975,2562,2105,1612,1090,550,0,-552,-1093,-1617,-2113,-2574,-2992,-3358,-3667,-3914,-4093,-4203,-4241,-4207,-4101,-3923,-3679,-3372,-3007,-2590,-2128,
		-1630,-1103,-557,-1,556,1103,1633,2134,2600,3021,3391,3703,3952,4134,4244,4283,4248,4141,3962,3715,3405,3036,2615,2148,1645,1113,561,0,-563,-1116,-1650,-2157,-2627,
		-3052,-3426,-3741,-3993,-4176,-4288,-4327,-4292,-4183,-4003,-3754,-3440,-3068,-2642,-2171,-1663,-1125,-568,-1,567,1126,1665,2177,2651,3081,3459,3777,4031,4216,4330,4369,
		4333,4223,4041,3790,3473,3096,2667,2191,1678,1135,572,0,-574,-1138,-1683,-2199,-2679,-3113,-3493,-3815,-4072,-4259,-4373,-4412,-4377,-4266,-4082,-3827,-3508,-3128,
		-2694,-2214,-1695,-1147,-579,-1,578,1148,1698,2220,2704,3142,3526,3851,4110,4299,4414,4454,4418,4306,4120,3863,3541,3157,2719,2234,1710,1157,583,0,-585,-1160,-1716,
		-2242,-2731,-3173,-3562,-3890,-4151,-4341,-4458,-4498,-4462,-4349,-4161,-3902,-3576,-3189,-2746,-2256,-1728,-1169,-590,-1,590,1170,1731,2263,2756,3203,3594,3926,4190,
		4382,4500,4540,4503,4389,4200,3939,3610,3218,2771,2277,1744,1179,595,0,-596,-1183,-1749,-2285,-2784,-3235,-3630,-3964,-4231,-4425,-4544,-4584,-4547,-4432,-4241,-3976,
		-3644,-3250,-2799,-2300,-1761,-1192,-602,-1,601,1192,1764,2306,2809,3263,3663,4000,4269,4465,4584,4626,4588,4472,4279,4012,3677,3279,2824,2320,1776,1201,606,0,-608,-1205,
		-1782,-2328,-2835,-3295,-3698,-4039,-4310,-4507,-4628,-4670,-4632,-4514,-4320,-4051,-3712,-3310,-2851,-2342,-1794,-1214,-613,-1,612,1214,1796,2348,2860,3323,3730,4074,
		4348,4547,4669,4711,4673,4553,4357,4086,3744,3338,2875,2362,1809,1223,617,0,-619,-1227,-1814,-2370,-2887,-3355,-3765,-4111,-4388,-4589,-4712,-4754,-4716,-4596,-4398,
		-4124,-3779,-3370,-2902,-2385,-1826,-1236,-624,-1,623,1236,1829,2391,2912,3383,3798,4147,4426,4630,4753,4796,4757,4636,4436,4159,3812,3399,2927,2405,1841,1245,628,0,
		-630,-1249,-1847,-2413,-2939,-3415,-3833,-4186,-4467,-4672,-4797,-4840,-4801,-4678,-4477,-4198,-3847,-3431,-2954,-2427,-1859,-1258,-635,-1,634,1258,1862,2433,2964,3444,
		3866,4221,4505,4712,4838,4882,4841,4718,4515,4234,3880,3459,2979,2448,1874,1267,639,0,-641,-1271,-1879,-2456,-2991,-3476,-3900,-4259,-4546,-4755,-4882,-4925,-4885,-4761,
		-4556,-4272,-3915,-3491,-3006,-2470,-1892,-1280,-646,-1,645,1280,1894,2476,3016,3504,3933,4295,4584,4795,4922,4967,4926,4802,4594,4308,3947,3520,3031,2490,1907,1290,650,
		0,-652,-1293,-1912,-2499,-3043,-3536,-3969,-4334,-4625,-4837,-4966,-5011,-4970,-4843,-4635,-4346,-3983,-3551,-3058,-2513,-1924,-1302,-657,-1,656,1302,1927,2519,3068,3564,
		4001,4369,4663,4876,5007,5052,5011,4883,4672,4381,4015,3579,3082,2533,1939,1311,661,0,-663,-1315,-1944,-2541,-3095,-3595,-4035,-4407,-4703,-4918,-5050,-5095,-5054,-4925,
		-4712,-4419,-4050,-3610,-3109,-2555,-1957,-1324,-668,-1,667,1324,1959,2561,3119,3624,4067,4442,4740,4958,5090,5136,5094,4965,4750,4454,4082,3639,3134,2575,1971,1333,672,
		0,-674,-1337,-1977,-2583,-3146,-3655,-4103,-4480,-4781,-5000,-5134,-5180,-5138,-5007,-4791,-4492,-4117,-3671,-3161,-2597,-1989,-1346,-679,-1,678,1346,1992,2603,3171,3685,
		4135,4515,4819,5040,5175,5222,5178,5047,4829,4528,4150,3700,3186,2618,2004,1355,684,0,-685,-1359,-2009,-2626,-3198,-3716,-4170,-4554,-4860,-5082,-5218,-5265,-5222,-5089,
		-4869,-4566,-4184,-3731,-3213,-2640,-2022,-1368,-690,-1,690,1368,2024,2646,3222,3744,4202,4589,4897,5122,5258,5306,5262,5129,4907,4601,4216,3760,3238,2660,2036,1377,695,
		0,-696,-1381,-2042,-2668,-3249,-3776,-4238,-4627,-4939,-5164,-5302,-5350,-5306,-5171,-4948,-4640,-4252,-3791,-3265,-2682,-2054,-1390,-701,-1,701,1390,2057,2688,3274,3804,
		4270,4662,4976,5203,5343,5391,5347,5210,4985,4675,4284,3819,3289,2702,2069,1399,706,0,-707,-1402,-2074,-2710,-3301,-3835,-4304,-4700,-5016,-5245,-5386,-5434,-5390,-5252,
		-5026,-4712,-4318,-3850,-3316,-2724,-2086,-1411,-712,-1,712,1412,2089,2730,3325,3863,4336,4735,5054,5284,5426,5475,5430,5291,5063,4747,4350,3878,3340,2744,2101,1421,717,
		0,-718,-1424,-2106,-2752,-3352,-3894,-4371,-4773,-5094,-5326,-5469,-5518,-5473,-5333,-5103,-4785,-4385,-3909,-3367,-2766,-2118,-1433,-723,-1,723,1434,2121,2772,3376,3923,
		4403,4808,5131,5366,5509,5559,5513,5372,5141,4820,4417,3938,3391,2786,2133,1443,728,0,-729,-1446,-2138,-2794,-3403,-3954,-4437,-4846,-5171,-5408,-5552,-5602,-5556,-5414,
		-5181,-4858,-4452,-3969,-3418,-2808,-2151,-1455,-734,-1,734,1455,2153,2814,3428,3982,4469,4881,5209,5447,5592,5643,5597,5453,5218,4893,4484,3997,3442,2828,2165,1464,738,
		0,-740,-1467,-2170,-2836,-3454,-4013,-4504,-4918,-5249,-5489,-5635,-5686,-5640,-5495,-5258,-4931,-4518,-4028,-3469,-2850,-2183,-1477,-745,-1,744,1477,2185,2856,3479,4042,
		4536,4953,5286,5528,5676,5727,5680,5535,5296,4966,4550,4057,3493,2870,2197,1486,749,0,-751,-1489,-2203,-2878,-3506,-4073,-4571,-4991,-5327,-5570,-5719,-5770,-5723,-5577,
		-5336,-5003,-4585,-4088,-3520,-2892,-2215,-1498,-756,-1,755,1499,2217,2898,3530,4101,4603,5026,5364,5609,5759,5811,5763,5616,5373,5038,4617,4116,3544,2912,2230,1508,760,
		0,-762,-1511,-2235,-2920,-3557,-4132,-4637,-5064,-5404,-5651,-5802,-5854,-5806,-5658,-5414,-5076,-4652,-4147,-3571,-2934,-2247,-1520,-767,-1,766,1520,2249,2940,3581,4160,
		4669,5099,5442,5690,5842,5895,5846,5697,5451,5111,4684,4175,3596,2954,2262,1530,771,0,-773,-1533,-2267,-2962,-3608,-4191,-4704,-5137,-5482,-5732,-5885,-5938,-5889,-5739,
		-5491,-5149,-4718,-4206,-3622,-2976,-2279,-1542,-778,-1,777,1542,2282,2982,3632,4220,4736,5172,5519,5771,5926,5979,5930,5778,5529,5184,4750,4235,3647,2996,2294,1551,782,
		0,-784,-1554,-2299,-3004,-3659,-4251,-4771,-5209,-5559,-5813,-5969,-6022,-5972,-5820,-5569,-5222,-4784,-4266,-3674,-3018,-2311,-1564,-789,-1,788,1564,2313,3023,3683,4279,
		4802,5243,5596,5851,6008,6062,6012,5858,5605,5256,4816,4293,3697,3037,2326,1573,793,0,-795,-1576,-2331,-3046,-3710,-4310,-4836,-5281,-5636,-5893,-6051,-6105,-6055,-5900,
		-5645,-5293,-4851,-4325,-3724,-3060,-2343,-1585,-800,-1,799,1585,2345,3065,3734,4338,4868,5316,5673,5933,6091,6146,6095,5939,5683,5328,4883,4353,3748,3079,2358,1594,804,
		0,-806,-1598,-2363,-3088,-3761,-4369,-4903,-5354,-5714,-5974,-6134,-6189,-6137,-5981,-5723,-5366,-4917,-4384,-3775,-3101,-2375,-1607,-811,-1,810,1607,2377,3107,3784,4397,
		4934,5388,5750,6013,6173,6229,6177,6019,5760,5400,4949,4412,3799,3121,2390,1616,815,0,-817,-1619,-2395,-3129,-3811,-4428,-4969,-5426,-5790,-6055,-6216,-6272,-6221,-6061,
		-5800,-5438,-4983,-4443,-3826,-3143,-2407,-1628,-822,-1,821,1629,2409,3149,3835,4456,5001,5461,5827,6094,6257,6312,6260,6101,5837,5472,5014,4471,3849,3162,2421,1638,826,
		0,-828,-1641,-2426,-3171,-3862,-4486,-5035,-5498,-5867,-6135,-6299,-6355,-6302,-6142,-5876,-5510,-5048,-4501,-3876,-3184,-2438,-1650,-833,-1,832,1650,2441,3190,3885,4515,
		5066,5532,5903,6173,6338,6395,6342,6180,5913,5544,5080,4529,3900,3204,2453,1659,837,0,-839,-1662,-2458,-3212,-3912,-4545,-5101,-5570,-5944,-6215,-6381,-6438,-6385,-6222,
		-5953,-5582,-5115,-4560,-3927,-3226,-2471,-1671,-843,-1,843,1672,2473,3232,3936,4573,5133,5605,5980,6254,6421,6478,6424,6261,5991,5616,5146,4588,3950,3245,2485,1681,847,
		0,-849,-1684,-2490,-3254,-3963,-4604,-5166,-5641,-6020,-6295,-6463,-6521,-6466,-6302,-6030,-5654,-5180,-4619,-3977,-3267,-2502,-1693,-854,-1,853,1693,2504,3273,3986,4632,
		5198,5676,6057,6333,6502,6561,6507,6340,6066,5688,5212,4646,4001,3287,2516,1702,858,0,-860,-1705,-2522,-3295,-4013,-4662,-5232,-5712,-6096,-6375,-6544,-6603,-6549,-6382,
		-6106,-5725,-5246,-4677,-4027,-3309,-2534,-1714,-865,-1,864,1714,2536,3314,4036,4690,5263,5747,6133,6414,6585,6643,6588,6420,6143,5759,5277,4705,4051,3328,2548,1723,869,
		0,-871,-1726,-2553,-3336,-4063,-4720,-5297,-5784,-6173,-6455,-6627,-6686,-6630,-6461,-6182,-5797,-5311,-4735,-4078,-3350,-2565,-1735,-876,-1,875,1736,2567,3355,4087,4749,
		5329,5818,6209,6493,6666,6726,6670,6499,6219,5831,5343,4763,4101,3369,2579,1745,880,0,-882,-1748,-2585,-3377,-4113,-4779,-5363,-5855,-6249,-6535,-6708,-6768,-6712,-6541,
		-6258,-5868,-5377,-4793,-4128,-3391,-2597,-1757,-887,-1,886,1757,2599,3397,4137,4807,5394,5890,6285,6573,6748,6808,6751,6580,6295,5902,5408,4822,4151,3410,2611,1766,891,
		0,-892,-1769,-2616,-3419,-4164,-4837,-5428,-5927,-6325,-6614,-6790,-6851,-6794,-6621,-6335,-5940,-5442,-4852,-4178,-3432,-2628,-1778,-897,-1,896,1778,2630,3438,4187,4865,
		5459,5961,6362,6652,6830,6891,6834,6659,6371,5974,5474,4880,4202,3452,2643,1787,901,0,-903,-1790,-2648,-3460,-4214,-4896,-5494,-5998,-6401,-6694,-6872,-6933,-6876,-6701,
		-6410,-6011,-5508,-4910,-4228,-3474,-2660,-1799,-908,-1,907,1800,2662,3479,4237,4923,5525,6033,6437,6732,6912,6973,6915,6739,6448,6045,5539,4938,4252,3493,2674,1809,912,
		0,-914,-1812,-2679,-3501,-4264,-4954,-5559,-6070,-6478,-6773,-6954,-7016,-6957,-6780,-6487,-6082,-5573,-4969,-4279,-3515,-2691,-1821,-919,-1,918,1821,2694,3520,4288,4982,
		5590,6104,6514,6811,6993,7056,6997,6818,6524,6116,5605,4996,4302,3534,2706,1830,923,0,-925,-1833,-2711,-3542,-4314,-5012,-5625,-6141,-6553,-6853,-7035,-7098,-7039,-6860,
		-6563,-6153,-5639,-5027,-4329,-3556,-2723,-1842,-930,-1,929,1842,2725,3562,4338,5040,5656,6175,6590,6892,7074,7138,7079,6897,6599,6187,5670,5054,4352,3575,2737,1851,934,
		0,-935,-1854,-2742,-3583,-4364,-5070,-5689,-6212,-6629,-6932,-7117,-7180,-7120,-6938,-6639,-6224,-5703,-5085,-4379,-3597,-2754,-1863,-940,-1,939,1864,2756,3602,4387,5098,
		5720,6246,6666,6970,7156,7220,7160,6977,6675,6258,5735,5112,4402,3616,2768,1872,944,0,-946,-1876,-2774,-3624,-4414,-5128,-5755,-6283,-6705,-7012,-7198,-7262,-7202,-7019,
		-6714,-6295,-5769,-5143,-4428,-3638,-2786,-1884,-951,-1,950,1885,2788,3644,4437,5156,5786,6317,6741,7050,7237,7302,7241,7056,6751,6329,5800,5170,4452,3657,2800,1894,955,
		0,-957,-1897,-2805,-3665,-4464,-5186,-5819,-6354,-6781,-7090,-7279,-7344,-7282,-7097,-6790,-6366,-5833,-5201,-4478,-3679,-2817,-1906,-962,-1,961,1906,2819,3684,4487,5214,
		5850,6388,6817,7128,7318,7384,7322,7135,6827,6401,5865,5228,4502,3698,2831,1915,966,0,-968,-1918,-2836,-3706,-4514,-5244,-5884,-6425,-6856,-7169,-7360,-7426,-7364,-7176,
		-6866,-6437,-5898,-5259,-4528,-3720,-2848,-1927,-972,-1,971,1927,2850,3725,4537,5271,5916,6458,6892,7207,7399,7465,7403,7213,6901,6471,5929,5285,4551,3739,2862,1936,976,
		0,-978,-1939,-2867,-3747,-4563,-5301,-5949,-6495,-6931,-7248,-7441,-7507,-7444,-7254,-6941,-6507,-5962,-5316,-4577,-3760,-2879,-1948,-983,-1,982,1948,2881,3766,4586,5328,
		5980,6528,6967,7286,7479,7546,7483,7291,6976,6541,
};

/**
 * Structure holding the main synth parameters
 */
synth_params_t synth_params;

/**
 * Dummy object pool
 */
object_pool_t object_pool;

/**
 * Oscillator class instance
 */
Oscillator osc1,osc2,osc3,osc4;

/**
 * Unit test output buffer
 */
q15_t pAdsr_out [BUFF_SIZE];


/** ADSR object instance*/
ADSR adsr;

/** Sound generator object instance*/
SoundGenerator snd_gen;

/** LFO object instance*/
LFO lfo;

/**
 * Sound generator test
 */
void test_sound_gen_out(void){

	/** Pointer to ADSR envelope frame  **/
	q15_t pAdsr[FRAME_SIZE];

	/** Pointer to oscillator frame  **/
	q15_t pOsc[FRAME_SIZE];

	q15_t adsr_sample;

	/** Put objects in the pool */
	object_pool.osc1 = 			&osc1;
	object_pool.osc2 = 			&osc2;
	object_pool.osc3 = 			&osc3;
	object_pool.osc4 = 			&osc4;
	object_pool.lfo = 			&lfo;
	object_pool.adsr = 			&adsr;

	/** Load initial default settings */
	init_settings(&synth_params,object_pool);

	/** Load initial default settings */
	init_settings(&synth_params,object_pool);


	/** Init oscillator with default settings and few custom */
    synth_params.osc_params.mixAB = MAX_AMP>>1;

	/** Init oscillator with default settings */
	osc1.init(&synth_params.osc_params);
	osc2.init(&synth_params.osc_params);
	osc3.init(&synth_params.osc_params);
	osc4.init(&synth_params.osc_params);

	/** Configure lfo */
	lfo.FM_synth = false;
	lfo.set_shape(SIN);
	lfo.set_freq_lut(4095);

	/** Define number of samples to stay on sustain state*/
	uint8_t sustain_timeout = 30;

	/** Init adsr */
	synth_params.adsr_params.sustain_level = MAX_AMP>>1;
	adsr.init(&synth_params);

	/** ADSR time params*/
	adsr.adsr_state = ATTACK_STATE;
	synth_params.note_ON = true;

	/** ADSR time params*/
	uint64_t att_time = rand();
	att_time = (att_time * 4096) / RAND_MAX;
	att_time = 1000;
	adsr.adsr_state = ATTACK_STATE;
	adsr.ph_inc_att = adsr_time_phinc_lut[att_time];
	adsr.ph_inc_dec = adsr_time_phinc_lut[200];
	adsr.ph_inc_rel = adsr_time_phinc_lut[1500];
	synth_params.note_ON = true;
	adsr.ph_inc = adsr.ph_inc_att;

	/** Specify the total number of frames */
	uint16_t _NFRAMES = BUFF_SIZE/FRAME_SIZE;

	/** Get ADSR envelope frames */
	for(int i=0; i< _NFRAMES; i++){

		if(adsr.adsr_state == SUSTAIN_STATE){
			sustain_timeout--;
		}
		if(sustain_timeout<=0){
			synth_params.note_ON = false;
		}

		/** Sound generation */
		snd_gen.gen_voice(&synth_params, pAdsr);


		/** Store frames in outuput buffer */
		arm_copy_q15(pAdsr,&pAdsr_out[i*FRAME_SIZE],FRAME_SIZE);

	};

	/** Print output buffer */
	printOutBuff("buff_sound_gen_out", &pAdsr_out[0], BUFF_SIZE);

	/** Compare output vs reference */
	TEST_ASSERT_EQUAL_INT16_ARRAY(buff_sound_gen_out,pAdsr_out,BUFF_SIZE);

}

int main(void)
{

	/** Init system and peripherals */
	ratatech_init(&synth_params);

	/** Load initial default settings */
	init_settings(&synth_params,object_pool);

    /** Turn off buffers, so IO occurs immediately  */
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stderr, NULL, _IONBF, 0);

    /** Wait usart confirmation to start the test  */
    wait_usart_ready();

	/** Ready to start test  */
    iprintf("\nTEST:  SOUND GEN\n-----------------------");

    /** Start unity and trigger tests */
    UNITY_BEGIN();
    RUN_TEST(test_sound_gen_out);

    /** FInish unity */
    return UNITY_END();
}
