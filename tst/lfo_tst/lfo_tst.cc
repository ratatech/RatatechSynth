/*
@file lfo_tst.cc

@brief LFO unit test

@ Created by Jordi Hidalgo, Ratatech, Mar 29, 2017
This file is part of XXXXXXX

    XXXXXXX is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    XXXXXXX is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with XXXXXXX.  If not, see <http://www.gnu.org/licenses/>
*/

#include <stdio.h>
#include "unity.h"
#include "ratatechSynth.h"
#include "tst_utils.h"

/**
 * Size of reference and output buffers
 */
#define BUFF_SIZE 256

/**
 * LFO sine unit test reference buffer
 */
q15_t buff_lfo_sin_ref[BUFF_SIZE] = {
		18688,21120,23680,25728,27520,29440,30720,31872,32384,32640,32512,32000,30848,29696,28160,25984,24064,21376,19072,16768,13952,11520,8960,6912,
		5120,3200,1920,768,256,0,128,640,1792,2944,4480,6656,8576,11264,13568,15872,18688,21120,23680,25728,27520,29440,30720,31872,32384,32640,32512,
		32000,30848,29696,28160,25984,24064,21376,19072,16768,13952,11520,8960,6912,5120,3200,1920,768,256,0,128,640,1792,2944,4480,6656,8576,11264,13568,
		15872,18688,21120,23680,25728,27520,29440,30720,31872,32384,32640,32512,32000,30848,29696,28160,25984,24064,21376,19072,16768,13952,11520,8960,6912,
		5120,3200,1920,768,256,0,128,640,1792,2944,4480,6656,8576,11264,13568,15872,18688,21120,23680,25728,27520,29440,30720,31872,32384,32640,32512,32000,
		30848,29696,28160,25984,24064,21376,19072,16768,13952,11520,8960,6912,5120,3200,1920,768,256,0,128,640,1792,2944,4480,6656,8576,11264,13568,15872,
		18688,21120,23680,25728,27520,29440,30720,31872,32384,32640,32512,32000,30848,29696,28160,25984,24064,21376,19072,16768,13952,11520,8960,6912,5120,
		3200,1920,768,256,0,128,640,1792,2944,4480,6656,8576,11264,13568,15872,18688,21120,23680,25728,27520,29440,30720,31872,32384,32640,32512,32000,30848,
		29696,28160,25984,24064,21376,19072,16768,13952,11520,8960,6912,5120,3200,1920,768,256,0,128,640,1792,2944,4480,6656,8576,11264,13568,15872,18688,21120,
		23680,25728,27520,29440,30720,31872,32384,32640,32512,32000,30848,29696,28160,25984,
};



/**
 * LFO saw unit test reference buffer
 */
q15_t buff_lfo_saw_ref[BUFF_SIZE] = {
		13824,14720,15488,16256,17152,17920,18816,19584,20352,21248,22016,22912,23680,24448,25344,26112,27008,27776,28544,29440,30208,31104,31872,16384,
		768,1536,2432,3200,3968,4864,5632,6528,7296,8064,8960,9728,10624,11392,12160,13056,13824,14720,15488,16256,17152,17920,18816,19584,20352,21248,22016,
		22912,23680,24448,25344,26112,27008,27776,28544,29440,30208,31104,31872,16384,768,1536,2432,3200,3968,4864,5632,6528,7296,8064,8960,9728,10624,11392,
		12160,13056,13824,14720,15488,16256,17152,17920,18816,19584,20352,21248,22016,22912,23680,24448,25344,26112,27008,27776,28544,29440,30208,31104,31872,
		16384,768,1536,2432,3200,3968,4864,5632,6528,7296,8064,8960,9728,10624,11392,12160,13056,13824,14720,15488,16256,17152,17920,18816,19584,20352,21248,
		22016,22912,23680,24448,25344,26112,27008,27776,28544,29440,30208,31104,31872,16384,768,1536,2432,3200,3968,4864,5632,6528,7296,8064,8960,9728,10624,
		11392,12160,13056,13824,14720,15488,16256,17152,17920,18816,19584,20352,21248,22016,22912,23680,24448,25344,26112,27008,27776,28544,29440,30208,
		31104,31872,16384,768,1536,2432,3200,3968,4864,5632,6528,7296,8064,8960,9728,10624,11392,12160,13056,13824,14720,15488,16256,17152,17920,18816,19584,
		20352,21248,22016,22912,23680,24448,25344,26112,27008,27776,28544,29440,30208,31104,31872,16384,768,1536,2432,3200,3968,4864,5632,6528,7296,8064,8960,
		9728,10624,11392,12160,13056,13824,14720,15488,16256,17152,17920,18816,19584,20352,21248,22016,22912,23680,24448,25344,26112,

};

/**
 * LFO triangle unit test reference buffer
 */
q15_t buff_lfo_tri_ref[BUFF_SIZE] = {
		11392,9856,8320,6528,4992,3200,1664,128,1536,3072,4864,6400,7936,9728,11264,13056,14592,16128,17920,19456,21248,22784,24320,26112,27648,29440,30976,
		32512,31104,29568,27776,26240,24704,22912,21376,19584,18048,16512,14720,13184,11392,9856,8320,6528,4992,3200,1664,128,1536,3072,4864,6400,7936,9728,
		11264,13056,14592,16128,17920,19456,21248,22784,24320,26112,27648,29440,30976,32512,31104,29568,27776,26240,24704,22912,21376,19584,18048,16512,
		14720,13184,11392,9856,8320,6528,4992,3200,1664,128,1536,3072,4864,6400,7936,9728,11264,13056,14592,16128,17920,19456,21248,22784,24320,26112,27648,
		29440,30976,32512,31104,29568,27776,26240,24704,22912,21376,19584,18048,16512,14720,13184,11392,9856,8320,6528,4992,3200,1664,128,1536,3072,4864,6400,
		7936,9728,11264,13056,14592,16128,17920,19456,21248,22784,24320,26112,27648,29440,30976,32512,31104,29568,27776,26240,24704,22912,21376,19584,18048,
		16512,14720,13184,11392,9856,8320,6528,4992,3200,1664,128,1536,3072,4864,6400,7936,9728,11264,13056,14592,16128,17920,19456,21248,22784,24320,26112,
		27648,29440,30976,32512,31104,29568,27776,26240,24704,22912,21376,19584,18048,16512,14720,13184,11392,9856,8320,6528,4992,3200,1664,128,1536,3072,
		4864,6400,7936,9728,11264,13056,14592,16128,17920,19456,21248,22784,24320,26112,27648,29440,30976,32512,31104,29568,27776,26240,24704,22912,21376,
		19584,18048,16512,14720,13184,11392,9856,8320,6528,4992,3200,1664,128,1536,3072,4864,6400,7936,9728,11264,13056,

};



/**
 * LFO osc modulation ref buffer
 */
q15_t buff_lfo_osc_mod_ref[BUFF_SIZE] = {
		26250,29116,5796,-23023,-32004,-12446,17595,32130,17595,-12495,-32004,-23114,5819,29232,26250,0,-26536,-29028,-6100,21449,29760,11139,-16685,-29696,
		-16188,10622,27528,19580,-5375,-24898,-22256,0,21105,22736,4370,-17108,-22932,-8771,11937,21042,11385,-7742,-19530,-13559,3289,16240,14070,0,-13268,-
		13924,-2875,9701,13144,4700,-6603,-11520,-6035,3854,9424,6230,-1675,-7316,-6313,0,5145,5452,966,-3640,-4410,-1519,2001,3150,1587,-980,-2142,-1365,276,
		1276,945,0,-535,-472,-75,178,124,47,0,0,0,0,124,89,-50,-354,-535,0,735,1044,253,-1274,-1890,-882,1380,2898,1863,-1421,-4158,-3185,920,5104,4935,0,-5778,-6962,
		-1625,5963,9052,3572,-5822,-11264,-6390,4559,12400,9434,-2800,-13570,-12947,0,13755,15892,3220,-13286,-18774,-7595,11178,20790,11730,-8477,-22554,-16835,
		4324,22388,20580,0,-22042,-24544,-5325,19135,27280,10528,-16046,-29440,-16472,11045,29512,21360,-6075,-28792,-26322,0,26250,29116,5796,-23023,-32004,
		-12446,17595,32130,17595,-12495,-32004,-23114,5819,29232,26250,0,-26536,-29028,-6100,21449,29760,11139,-16685,-29696,-16188,10622,27528,19580,-5375,
		-24898,-22256,0,21105,22736,4370,-17108,-22932,-8771,11937,21042,11385,-7742,-19530,-13559,3289,16240,14070,0,-13268,-13924,-2875,9701,13144,4700,-6603,
		-11520,-6035,3854,9424,6230,-1675,-7316,-6313,0,5145,5452,966,-3640,-4410,-1519,2001,3150,1587,-980,-2142,-1365,276,1276,945,0,-535,-472,-75,178,124,47,0,0,0,0,
		124,89,-50,-354,-535,0,



};

/**
 * Structure holding the main synth parameters
 */
synth_params_t synth_params;

/**
 * Dummy object pool
 */
object_pool_t object_pool;

/**
 * LFO class instance
 */
LFO lfo;

/**
 * Oscillator class instance
 */
Oscillator osc;

/**
 * Unit test output buffer
 */
q15_t pLfoOut[BUFF_SIZE];

/**
 * LFO sine oscillator unit test
 */
void test_lfo_sine_out(void){

	/** Pointer to oscillator frame  **/
	q15_t pLfo[FRAME_SIZE];

	/** Init oscillator with default settings */
	lfo.init(&synth_params.lfo_params);

	/** Store frames in outuput buffer */
	uint8_t _NFRAMES = BUFF_SIZE/FRAME_SIZE;

	/** Get oscillator samples */
	for(int i=0; i< _NFRAMES; i++){

		/** Get oscillator frames */
		lfo.get_frame(&synth_params,pLfo,FRAME_SIZE);

		/** Store frames in outuput buffer */
		arm_copy_q15(pLfo,&pLfoOut[i*FRAME_SIZE],FRAME_SIZE);

	};

	/** Print output buffer */
	printOutBuff("buff_lfo_sin_out", pLfoOut, BUFF_SIZE);

	/** Compare output vs reference */
	TEST_ASSERT_EQUAL_INT16_ARRAY(buff_lfo_sin_ref,pLfoOut,BUFF_SIZE);

}


/**
 * LFO saw oscillator unit test
 */
void test_lfo_saw_out(void){

	/** Pointer to oscillator frame  **/
	q15_t pLfo[FRAME_SIZE];

	/** Init oscillator with default settings */
	lfo.init(&synth_params.lfo_params);

	/** Set the lfo shape */
	lfo.set_shape(SAW);

	/** Store frames in outuput buffer */
	uint8_t _NFRAMES = BUFF_SIZE/FRAME_SIZE;

	/** Get oscillator samples */
	for(int i=0; i< _NFRAMES; i++){

		/** Get oscillator frames */
		lfo.get_frame(&synth_params,pLfo,FRAME_SIZE);

		/** Store frames in outuput buffer */
		arm_copy_q15(pLfo,&pLfoOut[i*FRAME_SIZE],FRAME_SIZE);

	};

	/** Print output buffer */
	printOutBuff("buff_lfo_saw_out", pLfoOut, BUFF_SIZE);

	/** Compare output vs reference */
	TEST_ASSERT_EQUAL_INT16_ARRAY(buff_lfo_saw_ref,pLfoOut,BUFF_SIZE);

}

/**
 * LFO triangle oscillator unit test
 */
void test_lfo_tri_out(void){


	/** Pointer to oscillator frame  **/
	q15_t pLfo[FRAME_SIZE];

	/** Init oscillator with default settings */
	lfo.init(&synth_params.lfo_params);

	/** Set the lfo shape */
	lfo.set_shape(TRI);

	/** Store frames in outuput buffer */
	uint8_t _NFRAMES = BUFF_SIZE/FRAME_SIZE;

	/** Get oscillator samples */
	for(int i=0; i< _NFRAMES; i++){

		/** Get oscillator frames */
		lfo.get_frame(&synth_params,pLfo,FRAME_SIZE);

		/** Store frames in outuput buffer */
		arm_copy_q15(pLfo,&pLfoOut[i*FRAME_SIZE],FRAME_SIZE);

	};

	/** Print output buffer */
	printOutBuff("buff_lfo_tri_out", pLfoOut, BUFF_SIZE);

	/** Compare output vs reference */
	TEST_ASSERT_EQUAL_INT16_ARRAY(buff_lfo_tri_ref,pLfoOut,BUFF_SIZE);

}


int main(void)
{

	/** Init system and peripherals */
	ratatech_init(&synth_params);

	/** Load initial default settings */
	init_settings(&synth_params,object_pool);

    /** Turn off buffers, so IO occurs immediately  */
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stderr, NULL, _IONBF, 0);

    /** Wait usart confirmation to start the test  */
    wait_usart_ready();
	/** Ready to start test  */
    iprintf("\nTEST:  LFO\n-----------------------");

    /** Start unity and trigger tests */
    UNITY_BEGIN();
    RUN_TEST(test_lfo_sine_out);
    RUN_TEST(test_lfo_saw_out);
    RUN_TEST(test_lfo_tri_out);


    /** FInish unity */
    return UNITY_END();
}

